///////////////////////////////////////////////////////////////////////////
// Precompilled headers
///////////////////////////////////////////////////////////////////////////
#include <pch.hpp>

///////////////////////////////////////////////////////////////////////////
// Headers
///////////////////////////////////////////////////////////////////////////
#include <xrn/Engine/System/MoveControlled.hpp>



///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
// Constructor
//
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////
///
///////////////////////////////////////////////////////////////////////////
::xrn::engine::system::MoveControlled::MoveControlled()
    : m_defaultDirection{
        ::glm::normalize(::glm::vec3(
            ::glm::cos(::glm::radians(0.0f)) * ::glm::cos(::glm::radians(0.0f))
            , ::glm::sin(::glm::radians(0.0f))
            , ::glm::sin(::glm::radians(0.0f)) * ::glm::cos(::glm::radians(0.0f))
        ))
    }
{}

///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
// Basic
//
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////
void ::xrn::engine::system::MoveControlled::operator()(
    ::xrn::engine::vulkan::FrameInfo& frameInfo
    , ::xrn::engine::component::Position& position
    , ::xrn::OptRef<::xrn::engine::component::Control> control
    , ::xrn::OptRef<::xrn::engine::component::Rotation> rotation
    , ::xrn::OptRef<::xrn::engine::component::Velocity> velocity
) const
{
    if (control) {
        ::xrn::OptRef<const ::glm::vec3> direction;
        if (rotation) {
            rotation->updateDirection(control);
            direction = rotation->getDirection();
        } else {
            direction = m_defaultDirection;
        }

        if (velocity) {
            velocity->update(frameInfo.deltaTime, control);
            position.update(control, velocity, direction);
        } else {
            position.update(frameInfo.deltaTime, control, direction);
        }
        return;
    }

    if (velocity) {
        ::xrn::OptRef<const ::glm::vec3> direction;
        if (rotation) {
            direction = rotation->getDirection();
        } else {
            direction = m_defaultDirection;
        }

        position.update(velocity, direction);
    }
}
